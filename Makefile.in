include defaults.mk
TARGET=mpop3
OBJECTS=main.o storage_default.o pop_commands.o pop3.o util.o modules.o auth_default.o parse_conffile.o net.o
ALSO_CLEAN=.gdb_history parse_conffile.c rendezvous_test_prog $(TARGET).conf
SUBDIRS=auth_file storage_mbox auth_getpw
FOO=@CONFIG_FILES@

.PHONY: all clean distclean install
.SUFFIXES: .lex

all: $(TARGET) $(TARGET).conf
	for dir in $(SUBDIRS); do (cd $$dir && $(MAKE) -I .. all); done

$(TARGET): $(OBJECTS)
	$(CC) $(LIBS) $(OBJECTS) -o $(TARGET)

clean:
	rm -f *.o $(TARGET) $(ALSO_CLEAN)
	for dir in $(SUBDIRS); do (cd $$dir && $(MAKE) -I .. clean); done

distclean: clean
	rm -rf config.{log,status} autom4te.cache Makefile defaults.mk module.mk config.h

.lex.c:
	$(LEX) -o$@ $<

.c.o:
	$(CC) $(DEFINES) -c $<

$(TARGET).conf: conf.sample
	sed 's#\$$SHARED_EXT#'$(SHARED_EXT)'#;s#\$$libdir#'$(libdir)'#' conf.sample > $(TARGET).conf

rendezvous_test_prog:
	gcc -o rendezvous_test_prog test_rendezvous.c

testrendezvous: rendezvous_test_prog
	./rendezvous_test_prog

install: all
	$(INSTALL) -d $(libdir)
	$(INSTALL_PROGRAM) $(TARGET) $(sbindir)
	$(INSTALL_DATA) $(TARGET).conf $(sysconfdir)
	for dir in $(SUBDIRS); do (cd $$dir && $(MAKE) -I .. install); done
	
